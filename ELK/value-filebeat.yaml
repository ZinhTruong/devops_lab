# ==== FILEBEAT VALUES (Helm - Elastic chart) ====

# Chỉ chạy DaemonSet để thu log node
deployment:
  enabled: false

daemonset:
  enabled: true

  # Biến môi trường cho add_kubernetes_metadata
  extraEnvs:
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName

  daemonsetVolumes:
    - name: varlogpods
      hostPath:
        path: /var/log/pods
    - name: varlibkubelet
      hostPath:
        path: /var/lib/kubelet

  daemonsetVolumeMounts:
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true
    - name: varlibkubelet
      mountPath: /var/lib/kubelet
      readOnly: true

  # Chạy root để đọc file log host (thường cần với containerd)
  securityContext:
    runAsUser: 0
    privileged: false

  # Cấu hình: đọc container logs -> đẩy về Logstash
  filebeatConfig:
    filebeat.yml: |
      filebeat.inputs:
        - type: container
          paths:
            - /var/log/containers/*.log
          symlinks: true
          processors:
            - add_kubernetes_metadata:
                host: ${NODE_NAME}
                matchers:
                  - logs_path:
                      logs_path: "/var/log/containers/"

      output.logstash:
        hosts: ['logstash-logstash:5044']

  resources:
    requests:
      cpu: "100m"
      memory: "100Mi"
    limits:
      cpu: "1000m"
      memory: "200Mi"

# QUAN TRỌNG: dùng emptyDir cho /usr/share/filebeat/data (tránh lock) 
# => để trống hostPathRoot để chart KHÔNG tạo hostPath cho 'data'
hostPathRoot: ""

# RBAC/SA: để chart tự tạo
managedServiceAccount: true
serviceAccount: ""



# Image như bạn đang dùng
image: "docker.elastic.co/beats/filebeat"
imageTag: "8.5.1"
imagePullPolicy: "IfNotPresent"
